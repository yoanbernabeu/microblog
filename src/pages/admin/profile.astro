---
import AdminLayout from '@layouts/AdminLayout.astro';

const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl === '/' ? '' : rawBaseUrl.replace(/\/$/, '');
const githubRepo = import.meta.env.PUBLIC_GITHUB_REPO || '';
---

<AdminLayout title="Modifier le profil">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">
      Modifier le profil
    </h1>

    <!-- Chargement -->
    <div id="loading-state" class="card p-8 text-center">
      <div class="inline-block w-8 h-8 border-2 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-2 text-slate-500 dark:text-slate-400">Chargement de la configuration...</p>
    </div>

    <!-- Erreur -->
    <div id="error-state" class="hidden card p-8 text-center">
      <div class="text-4xl mb-2">⚠️</div>
      <p class="text-slate-700 dark:text-slate-300" id="error-message">Erreur de chargement</p>
      <button type="button" id="retry-btn" class="btn-secondary mt-4">
        Réessayer
      </button>
    </div>

    <!-- Formulaire -->
    <form id="profile-form" class="hidden space-y-6">
      <!-- Avatar -->
      <div class="card p-6 space-y-4">
        <h2 class="font-semibold text-slate-900 dark:text-white">Avatar</h2>

        <div class="flex items-start gap-6">
          <!-- Prévisualisation -->
          <div id="avatar-preview" class="w-24 h-24 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden flex-shrink-0">
            <img id="avatar-img" src="" alt="Avatar" class="w-full h-full object-cover hidden" />
            <div id="avatar-placeholder" class="w-full h-full flex items-center justify-center text-slate-400">
              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
          </div>

          <!-- Zone d'upload -->
          <div class="flex-1">
            <div
              id="avatar-drop-zone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-4 text-center hover:border-primary-500 dark:hover:border-primary-400 transition-colors cursor-pointer"
            >
              <svg class="w-6 h-6 mx-auto text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                Glissez une image ou <span class="text-primary-600 dark:text-primary-400">cliquez pour sélectionner</span>
              </p>
              <p class="text-xs text-slate-400 mt-1">JPG, PNG, WebP - Max 2 Mo</p>
              <input type="file" id="avatar-input" class="hidden" accept="image/jpeg,image/png,image/webp" />
            </div>
            <button type="button" id="remove-avatar" class="hidden mt-2 text-sm text-red-600 hover:text-red-700 dark:text-red-400">
              Supprimer l'avatar
            </button>
          </div>
        </div>

        <!-- URL manuelle (fallback) -->
        <div>
          <label for="avatar-url" class="label text-sm text-slate-500">Ou entrer une URL directement</label>
          <input type="text" id="avatar-url" name="avatar" class="input text-sm" placeholder="/images/avatar.jpg" />
        </div>
      </div>

      <!-- Informations de base -->
      <div class="card p-6 space-y-4">
        <h2 class="font-semibold text-slate-900 dark:text-white">Informations de base</h2>

        <div>
          <label for="name" class="label">Nom</label>
          <input type="text" id="name" name="name" class="input" required />
        </div>

        <div>
          <label for="bio" class="label">Bio</label>
          <textarea id="bio" name="bio" class="textarea" rows="2"></textarea>
        </div>
      </div>

      <!-- Liens sociaux -->
      <div class="card p-6 space-y-4">
        <h2 class="font-semibold text-slate-900 dark:text-white">Réseaux sociaux</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="twitter" class="label">Twitter / X</label>
            <input type="url" id="twitter" name="twitter" class="input" placeholder="https://twitter.com/..." />
          </div>
          <div>
            <label for="github" class="label">GitHub</label>
            <input type="url" id="github" name="github" class="input" placeholder="https://github.com/..." />
          </div>
          <div>
            <label for="mastodon" class="label">Mastodon</label>
            <input type="url" id="mastodon" name="mastodon" class="input" placeholder="https://mastodon.social/@..." />
          </div>
          <div>
            <label for="linkedin" class="label">LinkedIn</label>
            <input type="url" id="linkedin" name="linkedin" class="input" placeholder="https://linkedin.com/in/..." />
          </div>
          <div>
            <label for="bluesky" class="label">Bluesky</label>
            <input type="url" id="bluesky" name="bluesky" class="input" placeholder="https://bsky.app/profile/..." />
          </div>
        </div>
      </div>

      <!-- Liens personnalisés -->
      <div class="card p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold text-slate-900 dark:text-white">Liens personnalisés</h2>
          <button type="button" id="add-link" class="btn-ghost text-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Ajouter
          </button>
        </div>

        <div id="custom-links" class="space-y-3">
          <!-- Les liens seront ajoutés ici dynamiquement -->
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex gap-3">
        <button type="submit" id="submit-btn" class="btn-primary flex-1">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

<script define:vars={{ baseUrl, githubRepo }}>
  const GITHUB_REPO = githubRepo;
  const API_BASE = 'https://api.github.com';
  const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2 Mo

  function getToken() {
    return sessionStorage.getItem('github_token');
  }

  function getHeaders() {
    return {
      'Authorization': `Bearer ${getToken()}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json',
    };
  }

  // Récupérer le contenu d'un fichier
  async function getFileContent(path) {
    const response = await fetch(`${API_BASE}/repos/${GITHUB_REPO}/contents/${path}`, {
      headers: getHeaders()
    });
    if (!response.ok) throw new Error('Fichier non trouvé');
    const file = await response.json();
    // Décoder le base64 avec support UTF-8
    return { content: decodeURIComponent(escape(atob(file.content))), sha: file.sha };
  }

  // Créer un blob (fichier) sur GitHub
  async function createBlob(content, encoding = 'utf-8') {
    const response = await fetch(`${API_BASE}/repos/${GITHUB_REPO}/git/blobs`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ content, encoding }),
    });
    if (!response.ok) throw new Error('Erreur création blob');
    return response.json();
  }

  // Obtenir la référence HEAD
  async function getRef(branch = 'main') {
    const response = await fetch(`${API_BASE}/repos/${GITHUB_REPO}/git/ref/heads/${branch}`, {
      headers: getHeaders(),
    });
    if (!response.ok) throw new Error('Erreur récupération ref');
    return response.json();
  }

  // Obtenir un commit
  async function getCommit(sha) {
    const response = await fetch(`${API_BASE}/repos/${GITHUB_REPO}/git/commits/${sha}`, {
      headers: getHeaders(),
    });
    if (!response.ok) throw new Error('Erreur récupération commit');
    return response.json();
  }

  // Créer un tree avec plusieurs fichiers
  async function createTree(baseTreeSha, files) {
    const tree = files.map(f => ({
      path: f.path,
      mode: '100644',
      type: 'blob',
      sha: f.sha,
    }));

    const response = await fetch(`${API_BASE}/repos/${GITHUB_REPO}/git/trees`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ base_tree: baseTreeSha, tree }),
    });
    if (!response.ok) throw new Error('Erreur création tree');
    return response.json();
  }

  // Créer un commit
  async function createCommit(message, treeSha, parentSha) {
    const response = await fetch(`${API_BASE}/repos/${GITHUB_REPO}/git/commits`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({
        message,
        tree: treeSha,
        parents: [parentSha],
      }),
    });
    if (!response.ok) throw new Error('Erreur création commit');
    return response.json();
  }

  // Mettre à jour la référence
  async function updateRef(sha, branch = 'main') {
    const response = await fetch(`${API_BASE}/repos/${GITHUB_REPO}/git/refs/heads/${branch}`, {
      method: 'PATCH',
      headers: getHeaders(),
      body: JSON.stringify({ sha }),
    });
    if (!response.ok) throw new Error('Erreur mise à jour ref');
    return response.json();
  }

  // Créer plusieurs fichiers en un seul commit
  async function createFilesInSingleCommit(files, message) {
    const blobs = await Promise.all(
      files.map(async (f) => {
        const blob = await createBlob(f.content, f.encoding || 'utf-8');
        return { path: f.path, sha: blob.sha };
      })
    );

    const ref = await getRef('main');
    const latestCommitSha = ref.object.sha;
    const latestCommit = await getCommit(latestCommitSha);
    const baseTreeSha = latestCommit.tree.sha;
    const newTree = await createTree(baseTreeSha, blobs);
    const newCommit = await createCommit(message, newTree.sha, latestCommitSha);
    await updateRef(newCommit.sha, 'main');

    return newCommit;
  }

  // Parser YAML simple
  function parseYaml(content) {
    const lines = content.split('\n');
    const result = { site: {}, author: {}, social: {}, links: [], feed: {} };
    let currentSection = null;
    let inLinks = false;
    let currentLink = null;

    for (const line of lines) {
      if (line.startsWith('#') || line.trim() === '') continue;

      if (line.match(/^[a-z]+:$/)) {
        currentSection = line.replace(':', '').trim();
        inLinks = currentSection === 'links';
        continue;
      }

      if (inLinks) {
        if (line.trim().startsWith('- label:')) {
          if (currentLink) result.links.push(currentLink);
          currentLink = { label: line.split(':').slice(1).join(':').trim().replace(/^['"]|['"]$/g, '') };
        } else if (line.trim().startsWith('url:') && currentLink) {
          currentLink.url = line.split(':').slice(1).join(':').trim().replace(/^['"]|['"]$/g, '');
        }
      } else if (currentSection && line.startsWith('  ')) {
        const match = line.match(/^\s+([a-zA-Z]+):\s*(.*)$/);
        if (match) {
          const key = match[1];
          let value = match[2].replace(/^['"]|['"]$/g, '');
          if (value === '' || value === '~' || value === 'null') value = '';
          if (!isNaN(Number(value)) && value !== '') value = Number(value);
          result[currentSection][key] = value;
        }
      }
    }

    if (currentLink) result.links.push(currentLink);
    return result;
  }

  // Générer YAML
  function generateYaml(config) {
    let yaml = '# Configuration du MicroBlog\n\n';

    yaml += 'site:\n';
    yaml += `  name: "${config.site.name || ''}"\n`;
    yaml += `  description: "${config.site.description || ''}"\n`;
    yaml += `  language: "${config.site.language || 'fr'}"\n\n`;

    yaml += 'author:\n';
    yaml += `  name: "${config.author.name || ''}"\n`;
    yaml += `  bio: "${config.author.bio || ''}"\n`;
    yaml += `  avatar: "${config.author.avatar || ''}"\n\n`;

    yaml += 'social:\n';
    const socialKeys = ['twitter', 'github', 'mastodon', 'linkedin', 'bluesky'];
    for (const key of socialKeys) {
      const value = config.social[key] || '';
      yaml += `  ${key}: ${value ? `"${value}"` : ''}\n`;
    }
    yaml += '\n';

    yaml += 'links:\n';
    if (config.links && config.links.length > 0) {
      for (const link of config.links) {
        yaml += `  - label: "${link.label}"\n`;
        yaml += `    url: "${link.url}"\n`;
      }
    }
    yaml += '\n';

    yaml += 'feed:\n';
    yaml += `  postsPerPage: ${config.feed.postsPerPage || 10}\n`;

    return yaml;
  }

  // Variables globales
  let config = null;
  let customLinks = [];
  let avatarFile = null;
  let avatarPreviewUrl = null;

  // Éléments DOM
  const form = document.getElementById('profile-form');
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const customLinksContainer = document.getElementById('custom-links');
  const addLinkBtn = document.getElementById('add-link');
  const submitBtn = document.getElementById('submit-btn');
  const avatarDropZone = document.getElementById('avatar-drop-zone');
  const avatarInput = document.getElementById('avatar-input');
  const avatarImg = document.getElementById('avatar-img');
  const avatarPlaceholder = document.getElementById('avatar-placeholder');
  const avatarUrlInput = document.getElementById('avatar-url');
  const removeAvatarBtn = document.getElementById('remove-avatar');

  // Charger la configuration
  async function loadConfig() {
    loadingState?.classList.remove('hidden');
    errorState?.classList.add('hidden');
    form?.classList.add('hidden');

    try {
      const { content } = await getFileContent('src/config.yml');
      config = parseYaml(content);

      // Remplir le formulaire
      document.getElementById('name').value = config.author.name || '';
      document.getElementById('bio').value = config.author.bio || '';
      avatarUrlInput.value = config.author.avatar || '';

      // Afficher l'avatar existant
      if (config.author.avatar) {
        const avatarSrc = config.author.avatar.startsWith('/')
          ? `${baseUrl}${config.author.avatar}`
          : config.author.avatar;
        avatarImg.src = avatarSrc;
        avatarImg.classList.remove('hidden');
        avatarPlaceholder.classList.add('hidden');
      }

      // Réseaux sociaux
      document.getElementById('twitter').value = config.social?.twitter || '';
      document.getElementById('github').value = config.social?.github || '';
      document.getElementById('mastodon').value = config.social?.mastodon || '';
      document.getElementById('linkedin').value = config.social?.linkedin || '';
      document.getElementById('bluesky').value = config.social?.bluesky || '';

      // Liens personnalisés
      customLinks = config.links || [];
      renderCustomLinks();

      loadingState?.classList.add('hidden');
      form?.classList.remove('hidden');
    } catch (error) {
      console.error('Failed to load config:', error);
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');
      document.getElementById('error-message').textContent = error.message;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderCustomLinks() {
    if (!customLinksContainer) return;

    customLinksContainer.innerHTML = customLinks.map((link, index) => `
      <div class="flex gap-2 items-start" data-link-index="${index}">
        <input
          type="text"
          class="input flex-1"
          placeholder="Label"
          value="${escapeHtml(link.label || '')}"
          data-field="label"
        />
        <input
          type="url"
          class="input flex-1"
          placeholder="https://..."
          value="${escapeHtml(link.url || '')}"
          data-field="url"
        />
        <button
          type="button"
          class="p-2 text-slate-400 hover:text-red-600 transition-colors"
          data-remove-link="${index}"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    `).join('');

    // Événements de mise à jour
    customLinksContainer.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', (e) => {
        const container = e.target.closest('[data-link-index]');
        const index = parseInt(container?.getAttribute('data-link-index') || '0');
        const field = e.target.getAttribute('data-field');
        customLinks[index][field] = e.target.value;
      });
    });

    // Boutons de suppression
    customLinksContainer.querySelectorAll('[data-remove-link]').forEach(btn => {
      btn.addEventListener('click', () => {
        const index = parseInt(btn.getAttribute('data-remove-link') || '0');
        customLinks.splice(index, 1);
        renderCustomLinks();
      });
    });
  }

  // Gestion de l'upload d'avatar
  function handleAvatarFile(file) {
    if (!file.type.startsWith('image/')) {
      alert('Veuillez sélectionner une image');
      return;
    }

    if (file.size > MAX_FILE_SIZE) {
      alert('L\'image ne doit pas dépasser 2 Mo');
      return;
    }

    avatarFile = file;

    const reader = new FileReader();
    reader.onload = (e) => {
      avatarPreviewUrl = e.target.result;
      avatarImg.src = avatarPreviewUrl;
      avatarImg.classList.remove('hidden');
      avatarPlaceholder.classList.add('hidden');
      removeAvatarBtn.classList.remove('hidden');
      // Vider l'URL manuelle
      avatarUrlInput.value = '';
    };
    reader.readAsDataURL(file);
  }

  // Drag & Drop pour l'avatar
  avatarDropZone?.addEventListener('click', () => avatarInput?.click());
  avatarDropZone?.addEventListener('dragover', (e) => {
    e.preventDefault();
    avatarDropZone.classList.add('border-primary-500');
  });
  avatarDropZone?.addEventListener('dragleave', () => {
    avatarDropZone.classList.remove('border-primary-500');
  });
  avatarDropZone?.addEventListener('drop', (e) => {
    e.preventDefault();
    avatarDropZone.classList.remove('border-primary-500');
    const file = e.dataTransfer?.files?.[0];
    if (file) handleAvatarFile(file);
  });

  avatarInput?.addEventListener('change', () => {
    const file = avatarInput.files?.[0];
    if (file) handleAvatarFile(file);
    avatarInput.value = '';
  });

  // Coller une image
  document.addEventListener('paste', (e) => {
    for (const item of (e.clipboardData?.items || [])) {
      if (item.type.startsWith('image/')) {
        const file = item.getAsFile();
        if (file) {
          e.preventDefault();
          handleAvatarFile(file);
          break;
        }
      }
    }
  });

  // Supprimer l'avatar
  removeAvatarBtn?.addEventListener('click', () => {
    avatarFile = null;
    avatarPreviewUrl = null;
    avatarImg.src = '';
    avatarImg.classList.add('hidden');
    avatarPlaceholder.classList.remove('hidden');
    removeAvatarBtn.classList.add('hidden');
    avatarUrlInput.value = '';
  });

  // Synchroniser l'URL manuelle avec l'aperçu
  avatarUrlInput?.addEventListener('input', () => {
    const url = avatarUrlInput.value.trim();
    if (url) {
      avatarFile = null;
      avatarPreviewUrl = null;
      const src = url.startsWith('/') ? `${baseUrl}${url}` : url;
      avatarImg.src = src;
      avatarImg.classList.remove('hidden');
      avatarPlaceholder.classList.add('hidden');
      avatarImg.onerror = () => {
        avatarImg.classList.add('hidden');
        avatarPlaceholder.classList.remove('hidden');
      };
    } else if (!avatarFile) {
      avatarImg.classList.add('hidden');
      avatarPlaceholder.classList.remove('hidden');
    }
  });

  // Ajouter un lien personnalisé
  addLinkBtn?.addEventListener('click', () => {
    customLinks.push({ label: '', url: '' });
    renderCustomLinks();
  });

  // Soumission du formulaire
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!config) return;

    submitBtn.setAttribute('disabled', 'true');
    submitBtn.innerHTML = `
      <svg class="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Enregistrement...
    `;

    try {
      const filesToCommit = [];
      let avatarPath = avatarUrlInput.value.trim();

      // Si une nouvelle image a été uploadée
      if (avatarFile && avatarPreviewUrl) {
        const ext = avatarFile.name.split('.').pop() || 'jpg';
        const timestamp = Date.now();
        const imagePath = `public/images/avatar-${timestamp}.${ext}`;

        // Extraire le contenu base64
        const base64Content = avatarPreviewUrl.split(',')[1];

        filesToCommit.push({
          path: imagePath,
          content: base64Content,
          encoding: 'base64',
        });

        avatarPath = `/images/avatar-${timestamp}.${ext}`;
      }

      // Mettre à jour la configuration
      config.author.name = document.getElementById('name').value;
      config.author.bio = document.getElementById('bio').value;
      config.author.avatar = avatarPath;

      config.social = {
        twitter: document.getElementById('twitter').value,
        github: document.getElementById('github').value,
        mastodon: document.getElementById('mastodon').value,
        linkedin: document.getElementById('linkedin').value,
        bluesky: document.getElementById('bluesky').value,
      };

      // Filtrer les liens vides
      config.links = customLinks.filter(l => l.label && l.url);

      // Générer le YAML
      const yamlContent = generateYaml(config);

      filesToCommit.push({
        path: 'src/config.yml',
        content: yamlContent,
        encoding: 'utf-8',
      });

      // Créer tous les fichiers en un seul commit
      await createFilesInSingleCommit(filesToCommit, 'Mise à jour du profil');

      alert('Profil mis à jour avec succès !');

      // Recharger pour mettre à jour
      avatarFile = null;
      avatarPreviewUrl = null;
      loadConfig();
    } catch (error) {
      console.error('Failed to update config:', error);
      alert('Erreur lors de la mise à jour: ' + error.message);
    } finally {
      submitBtn.removeAttribute('disabled');
      submitBtn.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Enregistrer
      `;
    }
  });

  document.getElementById('retry-btn')?.addEventListener('click', loadConfig);

  // Charger au démarrage
  loadConfig();
</script>
