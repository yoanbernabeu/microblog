---
const baseUrl = import.meta.env.BASE_URL;
---

<div
  id="search-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
  aria-label="Rechercher"
>
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" data-search-backdrop></div>

  <!-- Modal -->
  <div class="fixed inset-x-4 top-[10%] sm:inset-x-auto sm:left-1/2 sm:-translate-x-1/2 sm:w-full sm:max-w-lg">
    <div class="card shadow-2xl overflow-hidden">
      <!-- Input de recherche -->
      <div class="relative">
        <svg
          class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
        <input
          type="search"
          id="search-input"
          class="w-full pl-12 pr-12 py-4 text-lg bg-transparent border-b border-slate-200 dark:border-slate-700 focus:outline-none text-slate-900 dark:text-white placeholder-slate-400"
          placeholder="Rechercher..."
          autocomplete="off"
        />
        <kbd class="absolute right-4 top-1/2 -translate-y-1/2 px-2 py-0.5 text-xs font-medium text-slate-400 bg-slate-100 dark:bg-slate-700 rounded hidden sm:inline-flex">
          Esc
        </kbd>
      </div>

      <!-- Résultats -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto">
        <!-- État initial -->
        <div id="search-empty" class="p-8 text-center text-slate-500 dark:text-slate-400">
          <p>Commencez à taper pour rechercher...</p>
          <p class="text-sm mt-2">Recherchez dans les posts et les hashtags</p>
        </div>

        <!-- Chargement -->
        <div id="search-loading" class="p-8 text-center hidden">
          <div class="inline-block w-6 h-6 border-2 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
        </div>

        <!-- Liste des résultats -->
        <ul id="search-results-list" class="divide-y divide-slate-100 dark:divide-slate-700 hidden" role="listbox">
        </ul>

        <!-- Aucun résultat -->
        <div id="search-no-results" class="p-8 text-center text-slate-500 dark:text-slate-400 hidden">
          <p>Aucun résultat trouvé</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ baseUrl }}>
  let MiniSearch;
  let searchIndex = null;
  let miniSearch = null;
  let selectedIndex = -1;

  async function loadSearchIndex() {
    if (searchIndex) return;

    try {
      const response = await fetch(`${baseUrl}/search-index.json`);
      searchIndex = await response.json();

      // Charger MiniSearch dynamiquement
      const MiniSearchModule = await import('minisearch');
      MiniSearch = MiniSearchModule.default;

      miniSearch = new MiniSearch({
        fields: ['content', 'hashtags'],
        storeFields: ['id', 'content', 'hashtags', 'date', 'url', 'excerpt'],
        searchOptions: {
          boost: { hashtags: 2 },
          fuzzy: 0.2,
          prefix: true,
        },
      });

      miniSearch.addAll(searchIndex);
    } catch (error) {
      console.error('Failed to load search index:', error);
    }
  }

  function initSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const backdrop = document.querySelector('[data-search-backdrop]');
    const resultsList = document.getElementById('search-results-list');
    const emptyState = document.getElementById('search-empty');
    const loadingState = document.getElementById('search-loading');
    const noResultsState = document.getElementById('search-no-results');

    if (!modal || !input || !resultsList) return;

    // Ouvrir la recherche
    const openSearch = async () => {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      input.focus();
      selectedIndex = -1;

      // Charger l'index de recherche
      loadingState?.classList.remove('hidden');
      emptyState?.classList.add('hidden');
      await loadSearchIndex();
      loadingState?.classList.add('hidden');
      emptyState?.classList.remove('hidden');
    };

    // Fermer la recherche
    const closeSearch = () => {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      input.value = '';
      resultsList.innerHTML = '';
      resultsList.classList.add('hidden');
      emptyState?.classList.remove('hidden');
      noResultsState?.classList.add('hidden');
      selectedIndex = -1;
    };

    // Effectuer la recherche
    const performSearch = (query) => {
      if (!miniSearch || !query.trim()) {
        resultsList.classList.add('hidden');
        emptyState?.classList.remove('hidden');
        noResultsState?.classList.add('hidden');
        return;
      }

      emptyState?.classList.add('hidden');
      const results = miniSearch.search(query);

      if (results.length === 0) {
        resultsList.classList.add('hidden');
        noResultsState?.classList.remove('hidden');
        return;
      }

      noResultsState?.classList.add('hidden');
      resultsList.classList.remove('hidden');

      resultsList.innerHTML = results.slice(0, 10).map((result, index) => `
        <li role="option" aria-selected="${index === selectedIndex}">
          <a
            href="${result.url}"
            class="block p-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors ${index === selectedIndex ? 'bg-slate-50 dark:bg-slate-800' : ''}"
            data-result-index="${index}"
          >
            <p class="text-slate-800 dark:text-slate-200 line-clamp-2">${result.excerpt}</p>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
              ${new Date(result.date).toLocaleDateString('fr-FR')}
              ${result.hashtags ? ` • ${result.hashtags.split(' ').map(t => '#' + t).join(' ')}` : ''}
            </p>
          </a>
        </li>
      `).join('');

      selectedIndex = -1;
    };

    // Navigation clavier
    const handleKeydown = (e) => {
      const items = resultsList.querySelectorAll('a[data-result-index]');

      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelection(items);
          break;
        case 'ArrowUp':
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelection(items);
          break;
        case 'Enter':
          if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].click();
          }
          break;
        case 'Escape':
          closeSearch();
          break;
      }
    };

    const updateSelection = (items) => {
      items.forEach((item, index) => {
        const li = item.parentElement;
        if (index === selectedIndex) {
          item.classList.add('bg-slate-50', 'dark:bg-slate-800');
          li?.setAttribute('aria-selected', 'true');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('bg-slate-50', 'dark:bg-slate-800');
          li?.setAttribute('aria-selected', 'false');
        }
      });
    };

    // Event listeners
    window.addEventListener('open-search', openSearch);

    // Cmd+K / Ctrl+K
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
    });

    backdrop?.addEventListener('click', closeSearch);

    input.addEventListener('input', (e) => {
      performSearch(e.target.value);
    });

    input.addEventListener('keydown', handleKeydown);
  }

  initSearch();
  document.addEventListener('astro:after-swap', initSearch);
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
