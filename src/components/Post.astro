---
import type { PostWithHashtags } from '@lib/posts';
import { parsePostContent, formatPostDate, formatDatetime, extractFirstLink, isYouTubeUrl, extractYouTubeId } from '@lib/posts';
import PostImages from './PostImages.astro';
import PostDate from './PostDate.astro';
import YouTubeEmbed from './YouTubeEmbed.astro';
import LinkPreview from './LinkPreview.astro';

interface Props {
  post: PostWithHashtags;
  isDetail?: boolean;
}

const { post, isDetail = false } = Astro.props;
const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl === '/' ? '' : rawBaseUrl.replace(/\/$/, '');

const content = post.body || '';
const htmlContent = parsePostContent(content, baseUrl);
const postUrl = `${baseUrl}/post/${post.slug || post.id.replace('.md', '')}`;

// Detection du premier lien
const firstLink = extractFirstLink(content);
const isYouTube = firstLink ? isYouTubeUrl(firstLink) : false;
const youtubeId = isYouTube && firstLink ? extractYouTubeId(firstLink) : null;
---

<article class="group relative">
  <!-- Glow effect on hover -->
  <div class="absolute -inset-0.5 bg-gradient-to-r from-primary-500 to-accent-500 rounded-2xl opacity-0 group-hover:opacity-100 blur transition-all duration-500 pointer-events-none"></div>

  <!-- Card content -->
  <div class="relative bg-white dark:bg-surface-900 rounded-2xl p-6 border border-surface-200 dark:border-surface-800 group-hover:border-transparent transition-colors">
    <!-- Content -->
    <div
      class="prose prose-lg prose-surface dark:prose-invert max-w-none text-surface-800 dark:text-surface-200 prose-a:text-primary-500 prose-a:font-semibold prose-a:no-underline hover:prose-a:underline prose-strong:text-surface-900 dark:prose-strong:text-white"
      set:html={htmlContent}
    />

    <!-- Images -->
    {post.data.images && post.data.images.length > 0 && (
      <PostImages images={post.data.images} />
    )}

    <!-- YouTube Embed -->
    {youtubeId && (
      <YouTubeEmbed videoId={youtubeId} />
    )}

    <!-- Link Preview (si pas YouTube) -->
    {firstLink && !isYouTube && (
      <LinkPreview url={firstLink} />
    )}

    <!-- Footer -->
    <footer class="mt-6 pt-4 border-t border-surface-100 dark:border-surface-800 flex items-center justify-between">
      <PostDate date={post.data.publishedAt} />

      {!isDetail && (
        <a
          href={postUrl}
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-primary-500 to-accent-500 rounded-full hover:shadow-lg hover:shadow-primary-500/25 hover:scale-105 transition-all duration-300"
        >
          <span>Lire</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      )}

      {isDetail && (
        <button
          type="button"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-primary-500 to-accent-500 rounded-full hover:shadow-lg hover:shadow-primary-500/25 hover:scale-105 transition-all duration-300"
          data-share-url={new URL(postUrl, Astro.site).href}
          aria-label="Partager ce post"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
          <span>Partager</span>
        </button>
      )}
    </footer>
  </div>
</article>

<script>
  function initShareButtons() {
    document.querySelectorAll('[data-share-url]').forEach(button => {
      button.addEventListener('click', async () => {
        const url = button.getAttribute('data-share-url');
        if (!url) return;

        if (navigator.share) {
          try {
            await navigator.share({ url });
          } catch {
            // User cancelled or error
          }
        } else {
          await navigator.clipboard.writeText(url);
        }
      });
    });
  }

  initShareButtons();
  document.addEventListener('astro:after-swap', initShareButtons);
</script>
